# Import, include and tags

Q: How do import & include statements interact with tags?

A: It's complicated.

The site.yml playbook has two plays, testing including and importing task files
and roles.

## Task files

Specifying a tag on a task in a task file works when the task file is imported,
but not when it is included.

```
ansible-playbook site.yml --tags task-file

PLAY [localhost] *******************************************************************************************************************************************************************************************

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "import task file"
}

TASK [Task file task] **************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "Hello"
}

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "include task file"
}

PLAY [localhost] *******************************************************************************************************************************************************************************************

PLAY RECAP *************************************************************************************************************************************************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

This is because with a dynamic include, the included tasks are not in the task
list until the include task runs. However, since the include task does not
match the task-file tag, it does not run.

If we now specify a tag applied to the import task, all imported tasks are matched:

```
ansible-playbook site.yml --tags import-tasks

PLAY [localhost] *******************************************************************************************************************************************************************************************

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "import task file"
}

TASK [Task file task] **************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "Hello"
}

PLAY [localhost] *******************************************************************************************************************************************************************************************

PLAY RECAP *************************************************************************************************************************************************************************************************
localhost
```

Whereas if we specify a tag applied to the include task, the included tasks are
not matched:

```
ansible-playbook site.yml --tags include-tasks

PLAY [localhost] *******************************************************************************************************************************************************************************************

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "include task file"
}

TASK [include_tasks] ***************************************************************************************************************************************************************************************
included: /home/mark/src/ansible-experiments/06-import-include-and-tags/tasks.yml for localhost

PLAY [localhost] *******************************************************************************************************************************************************************************************

PLAY RECAP *************************************************************************************************************************************************************************************************
localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

Specifying a tag assigned to the play runs all tasks:

```
ansible-playbook site.yml --tags tasks-play

PLAY [localhost] *******************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************
ok: [localhost]

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "import task file"
}

TASK [Task file task] **************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "Hello"
}

TASK [debug] ***********************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "include task file"
}

TASK [include_tasks] ***************************************************************************************************************************************************************************************
included: /home/mark/src/ansible-experiments/06-import-include-and-tags/tasks.yml for localhost

TASK [Task file task] **************************************************************************************************************************************************************************************
ok: [localhost] => {
        "msg": "Hello"
}

PLAY [localhost] *******************************************************************************************************************************************************************************************

PLAY RECAP *************************************************************************************************************************************************************************************************
localhost                  : ok=6    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

## Roles

Import and include for roles have the same behaviour as for task files with
regards to tags, and the old style roles section behaves like a static import.
